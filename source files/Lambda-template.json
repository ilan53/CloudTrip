{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "SyncUserToDynamo": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": "CognitoUserToDynamo",
        "Handler": "index.handler",
        "Runtime": "nodejs18.x",
        "Role": {
          "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/LabRole"
        },
        "Code": {
          "ZipFile": {
            "Fn::Join": [
              "\n",
              [
                "const AWS = require('aws-sdk');",
                "const docClient = new AWS.DynamoDB.DocumentClient();",
                "",
                "exports.handler = async (event) => {",
                "  const email = event.request.userAttributes.email;",
                "  const fullName = `${event.request.userAttributes.name} ${event.request.userAttributes.family_name}`.trim();",
                "",
                "  const params = {",
                "    TableName: 'Users',",
                "    Key: { email }",
                "  };",
                "",
                "  const result = await docClient.get(params).promise();",
                "  if (!result.Item) {",
                "    await docClient.put({",
                "      TableName: 'Users',",
                "      Item: {",
                "        email,",
                "        fullName,",
                "        bookedFlights: []",
                "      }",
                "    }).promise();",
                "  }",
                "",
                "  return event;",
                "};"
              ]
            ]
          }
        }
      }
    }
  }
}

{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "StaticWebsiteBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": "cloudtrip2",
        "WebsiteConfiguration": {
          "IndexDocument": "index.html",
          "ErrorDocument": "index.html"
        },
        "CorsConfiguration": {
          "CorsRules": [
            {
              "AllowedHeaders": [ "*" ],
              "AllowedMethods": [ "GET", "PUT", "POST" ],
              "AllowedOrigins": [
                "https://czohwpuhzi.execute-api.us-east-1.amazonaws.com/prod",
                "http://cloudtrip.s3.us-east-1.amazonaws.com"
              ]
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": false,
          "IgnorePublicAcls": false,
          "BlockPublicPolicy": false,
          "RestrictPublicBuckets": false
        }
      }
    },

    "BucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "StaticWebsiteBucket" },
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:s3:::",
                    { "Ref": "StaticWebsiteBucket" },
                    "/*"
                  ]
                ]
              }
            }
          ]
        }
      }
    },

    "UserPool": {
      "Type": "AWS::Cognito::UserPool",
      "Properties": {
        "UserPoolName": "CloudTripUserPool",
        "UsernameConfiguration": {
          "CaseSensitive": false
        },
        "UsernameAttributes": [ "email" ],
        "AutoVerifiedAttributes": [ "email" ],
        "Schema": [
          {
            "Name": "email",
            "Required": true,
            "Mutable": true
          },
          {
            "Name": "name",
            "Required": true,
            "Mutable": true
          },
          {
            "Name": "family_name",
            "Required": true,
            "Mutable": true
          }
        ],
        "Policies": {
          "PasswordPolicy": {
            "MinimumLength": 8,
            "RequireUppercase": true,
            "RequireLowercase": true,
            "RequireNumbers": true,
            "RequireSymbols": false
          }
        },
        "AdminCreateUserConfig": {
          "AllowAdminCreateUserOnly": false
        },
        "AccountRecoverySetting": {
          "RecoveryMechanisms": [
            {
              "Name": "verified_email",
              "Priority": 1
            }
          ]
        }
      }
    },

    "UserPoolClient": {
      "Type": "AWS::Cognito::UserPoolClient",
      "Properties": {
        "ClientName": "CloudTripClient",
        "UserPoolId": { "Ref": "UserPool" },
        "GenerateSecret": false,
        "ExplicitAuthFlows": [
          "ALLOW_USER_PASSWORD_AUTH",
          "ALLOW_USER_SRP_AUTH",
          "ALLOW_REFRESH_TOKEN_AUTH",
          "ALLOW_ADMIN_USER_PASSWORD_AUTH",
          "ALLOW_CUSTOM_AUTH",
          "ALLOW_USER_AUTH"
        ],
        "SupportedIdentityProviders": [ "COGNITO" ],
        "CallbackURLs": [
          "https://cloudtrip2.s3.us-east-1.amazonaws.com/index.html"
        ],
        "LogoutURLs": [
          "https://cloudtrip2.s3.us-east-1.amazonaws.com/index.html"
        ],
        "AccessTokenValidity": 60,
        "IdTokenValidity": 60,
        "RefreshTokenValidity": 5,
        "TokenValidityUnits": {
          "AccessToken": "minutes",
          "IdToken": "minutes",
          "RefreshToken": "days"
        },
        "PreventUserExistenceErrors": "ENABLED"
      }
    },

    "UserGroupAdmins": {
      "Type": "AWS::Cognito::UserPoolGroup",
      "Properties": {
        "GroupName": "Admins",
        "UserPoolId": { "Ref": "UserPool" },
        "Description": "Admin group for CloudTrip"
      }
    }
  },

  "Outputs": {
    "S3WebsiteURL": {
      "Value": {
        "Fn::GetAtt": [ "StaticWebsiteBucket", "WebsiteURL" ]
      }
    },
    "UserPoolId": {
      "Value": { "Ref": "UserPool" }
    },
    "UserPoolClientId": {
      "Value": { "Ref": "UserPoolClient" }
    }
  }
}
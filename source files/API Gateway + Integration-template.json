{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "SyncUserApi": {
      "Type": "AWS::ApiGatewayV2::Api",
      "Properties": {
        "Name": "SyncUserApi",
        "ProtocolType": "HTTP"
      }
    },
    "SyncUserApiStage": {
      "Type": "AWS::ApiGatewayV2::Stage",
      "Properties": {
        "ApiId": { "Ref": "SyncUserApi" },
        "StageName": "prod",
        "AutoDeploy": true
      }
    },
    "SyncUserIntegration": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": { "Ref": "SyncUserApi" },
        "IntegrationType": "AWS_PROXY",
        "IntegrationUri": {
          "Fn::GetAtt": [ "SyncUserToDynamo", "Arn" ]
        },
        "PayloadFormatVersion": "2.0",
        "IntegrationMethod": "POST"
      }
    },
    "SyncUserRoute": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": { "Ref": "SyncUserApi" },
        "RouteKey": "POST /syncUser",
        "Target": {
          "Fn::Join": [
            "/",
            [
              "integrations",
              { "Ref": "SyncUserIntegration" }
            ]
          ]
        }
      }
    },
    "SyncUserPermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": { "Ref": "SyncUserToDynamo" },
        "Action": "lambda:InvokeFunction",
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Sub": "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SyncUserApi}/*/POST/syncUser"
        }
      }
    }
  },
  "Outputs": {
    "ApiEndpoint": {
      "Description": "Invoke URL for syncUser endpoint",
      "Value": {
        "Fn::Sub": "https://${SyncUserApi}.execute-api.${AWS::Region}.amazonaws.com/prod/syncUser"
      }
    }
  }
}
